---
RecipeFormatVersion: 2020-01-25
ComponentName: com.edgesnackdispenser.core
ComponentVersion: 1.0.0
ComponentDescription: "Edge Snack Dispenser with computer vision-based snack level detection"
ComponentPublisher: EdgeSnackDispenser

ComponentConfiguration:
  DefaultConfiguration:
    checkInterval: 5
    confidenceThreshold: 0.7
    accessControl:
      aws.greengrass.ipc.mqttproxy:
        policies:
          - policyDescription: "Allows MQTT communication"
            operations:
              - aws.greengrass#PublishToIoTCore
              - aws.greengrass#SubscribeToIoTCore
            resources:
              - "edgesnackdispenser/+/status"
              - "edgesnackdispenser/+/control"

Manifests:
  - Platform:
      os: linux
    Artifacts:
      - URI: s3://edge-snack-dispenser-artifacts/edge-snack-dispenser.zip
        Unarchive: ZIP
    Lifecycle:
      Install:
        RequiresPrivilege: true
        Script: |
          #!/bin/bash
          set -e
          
          # Install system dependencies
          apt-get update
          apt-get install -y python3-pip python3-venv python3-opencv

          # Create virtual environment
          VENV_DIR=/greengrass/v2/packages/venv/edgesnack
          python3 -m venv $VENV_DIR
          
          # Activate virtual environment and install dependencies
          source $VENV_DIR/bin/activate
          pip3 install --no-cache-dir -r {artifacts:decompressedPath}/requirements.txt
          
          # Create a wrapper script to run with venv
          cat > {artifacts:decompressedPath}/run.sh << 'EOL'
          #!/bin/bash
          source /greengrass/v2/packages/venv/edgesnack/bin/activate
          export PYTHONPATH={artifacts:decompressedPath}
          exec python3 -u aws/main.py
          EOL
          
          chmod +x {artifacts:decompressedPath}/run.sh
      Run:
        RequiresPrivilege: true
        Script: |
          {artifacts:decompressedPath}/run.sh